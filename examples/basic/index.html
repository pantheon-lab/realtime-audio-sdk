<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Realtime Audio SDK - Basic Example</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    .controls {
      margin: 20px 0;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      font-size: 14px;
      cursor: pointer;
    }
    select {
      padding: 8px;
      font-size: 14px;
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      background: #f0f0f0;
      border-radius: 4px;
    }
    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin: 20px 0;
    }
    .metric {
      padding: 10px;
      background: #e8f4f8;
      border-radius: 4px;
    }
    .metric label {
      font-size: 12px;
      color: #666;
    }
    .metric value {
      font-size: 18px;
      font-weight: bold;
      display: block;
    }
    .logs {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 10px;
      border-radius: 4px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }
    .log-entry {
      margin: 2px 0;
    }
  </style>
</head>
<body>
  <h1>Realtime Audio SDK - Basic Example</h1>

  <div class="controls">
    <h3>Audio Device</h3>
    <select id="deviceSelect">
      <option value="">Select a device...</option>
    </select>
  </div>

  <div class="controls">
    <h3>Configuration</h3>
    <label>
      Frame Size:
      <select id="frameSize">
        <option value="20">20ms</option>
        <option value="40">40ms</option>
        <option value="60">60ms</option>
      </select>
    </label>
    <label>
      <input type="checkbox" id="vadEnabled" checked>
      Enable VAD
    </label>
    <label>
      <input type="checkbox" id="normalize">
      Normalize Audio
    </label>
  </div>

  <div class="controls">
    <button id="startBtn">Start Recording</button>
    <button id="stopBtn" disabled>Stop Recording</button>
    <button id="pauseBtn" disabled>Pause</button>
    <button id="resumeBtn" disabled>Resume</button>
  </div>

  <div class="status">
    <strong>Status:</strong> <span id="status">Idle</span>
  </div>

  <div class="metrics">
    <div class="metric">
      <label>Chunks Received</label>
      <value id="chunkCount">0</value>
    </div>
    <div class="metric">
      <label>Audio Energy</label>
      <value id="energy">0.00</value>
    </div>
    <div class="metric">
      <label>Speech Detected</label>
      <value id="isSpeech">No</value>
    </div>
    <div class="metric">
      <label>Codec</label>
      <value id="codec">-</value>
    </div>
  </div>

  <h3>Event Logs</h3>
  <div class="logs" id="logs"></div>

  <script type="module">
    import { RealtimeAudioSDK } from '../../src/index.ts';

    let sdk = null;
    let chunkCount = 0;

    // DOM elements
    const deviceSelect = document.getElementById('deviceSelect');
    const frameSizeSelect = document.getElementById('frameSize');
    const vadCheckbox = document.getElementById('vadEnabled');
    const normalizeCheckbox = document.getElementById('normalize');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const resumeBtn = document.getElementById('resumeBtn');
    const statusEl = document.getElementById('status');
    const chunkCountEl = document.getElementById('chunkCount');
    const energyEl = document.getElementById('energy');
    const isSpeechEl = document.getElementById('isSpeech');
    const codecEl = document.getElementById('codec');
    const logsEl = document.getElementById('logs');

    // Initialize SDK
    function initSDK() {
      const processingConfig = {
        normalize: normalizeCheckbox.checked,
      };

      // Only add VAD config if enabled
      if (vadCheckbox.checked) {
        processingConfig.vad = {
          enabled: true,
          positiveSpeechThreshold: 0.6,  // Higher threshold to reduce false positives
          negativeSpeechThreshold: 0.45, // Higher threshold for ending speech
          silenceDuration: 800,           // Shorter silence duration (800ms)
          preSpeechPadDuration: 300,
          minSpeechDuration: 100,         // Lower min duration to catch short utterances
          modelPath: '/public/models/silero_vad_v5.onnx',
        };
      }

      const config = {
        frameSize: parseInt(frameSizeSelect.value),
        encoding: {
          enabled: true,
          codec: 'opus',
          bitrate: 16000,
        },
        processing: processingConfig,
        autoSwitchDevice: true,
      };

      sdk = new RealtimeAudioSDK(config);
      setupEventListeners();
      log('SDK initialized');
    }

    // Setup event listeners
    function setupEventListeners() {
      // Main audio event (unified)
      sdk.on('audio', (event) => {
        const { audio, metadata, processing } = event;

        chunkCount++;
        chunkCountEl.textContent = chunkCount;
        codecEl.textContent = audio.format ? audio.format.toUpperCase() : 'RAW';

        // Update energy
        energyEl.textContent = processing.energy.toFixed(3);

        // Update VAD status if active
        if (processing.vad?.active) {
          isSpeechEl.textContent = processing.vad.isSpeech ? 'Yes' : 'No';
        }
      });

      // State changes
      sdk.on('state', (state) => {
        statusEl.textContent = state.charAt(0).toUpperCase() + state.slice(1);
        updateButtonStates(state);
        log(`State changed: ${state}`);
      });

      // VAD speech state events
      sdk.on('speech-state', (event) => {
        console.log('Speech state event:', event);
        if (event.type === 'start') {
          log(`Speech started (probability: ${event.probability.toFixed(2)})`);
        } else {
          log(`Speech ended (duration: ${event.duration}ms)`);
        }
      });

      // VAD speech segment events
      sdk.on('speech-segment', (event) => {
        log(`Speech segment: ${event.duration}ms, confidence: ${event.confidence.toFixed(2)}, samples: ${event.audio.length}`);
      });

      // Device events (unified)
      sdk.on('device', (event) => {
        switch (event.type) {
          case 'changed':
            log(`Device changed: ${event.device?.label}`);
            break;
          case 'unplugged':
            log(`Device unplugged: ${event.deviceId}`);
            break;
          case 'list-updated':
            log(`Device list updated: ${event.devices?.length} devices`);
            break;
        }
      });

      // Error handling
      sdk.on('error', (error) => {
        log(`Error: ${error.message}`, 'error');
      });
    }

    // Load devices
    async function loadDevices() {
      if (!sdk) initSDK();

      const devices = await sdk.getDevices();
      deviceSelect.innerHTML = '<option value="">Default Device</option>';

      devices.forEach(device => {
        const option = document.createElement('option');
        option.value = device.deviceId;
        option.textContent = device.label || `Device ${device.deviceId.slice(0, 8)}`;
        deviceSelect.appendChild(option);
      });

      log(`Loaded ${devices.length} devices`);
    }

    // Button handlers
    startBtn.addEventListener('click', async () => {
      try {
        // Recreate SDK with current config (to respect checkbox states)
        if (sdk) {
          await sdk.destroy();
        }
        initSDK();

        if (deviceSelect.value) {
          await sdk.setDevice(deviceSelect.value);
        }

        await sdk.start();
        chunkCount = 0;
        chunkCountEl.textContent = '0';
      } catch (error) {
        log(`Failed to start: ${error.message}`, 'error');
      }
    });

    stopBtn.addEventListener('click', async () => {
      try {
        await sdk.stop();
      } catch (error) {
        log(`Failed to stop: ${error.message}`, 'error');
      }
    });

    pauseBtn.addEventListener('click', async () => {
      try {
        await sdk.pause();
      } catch (error) {
        log(`Failed to pause: ${error.message}`, 'error');
      }
    });

    resumeBtn.addEventListener('click', async () => {
      try {
        await sdk.resume();
      } catch (error) {
        log(`Failed to resume: ${error.message}`, 'error');
      }
    });

    // Update button states
    function updateButtonStates(state) {
      startBtn.disabled = state === 'recording' || state === 'paused';
      stopBtn.disabled = state === 'idle';
      pauseBtn.disabled = state !== 'recording';
      resumeBtn.disabled = state !== 'paused';
    }

    // Logging
    function log(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      const timestamp = new Date().toLocaleTimeString();
      const color = type === 'error' ? '#ff6b6b' : '#4ecdc4';
      entry.innerHTML = `<span style="color: #888">[${timestamp}]</span> <span style="color: ${color}">${message}</span>`;
      logsEl.appendChild(entry);
      logsEl.scrollTop = logsEl.scrollHeight;
    }

    // Initialize
    loadDevices();
  </script>
</body>
</html>
